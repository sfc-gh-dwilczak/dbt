version: 2

semantic_models:
  - name: account_metering
    model: ref('fct_snowflake__metering_history', v=1)
    description: '{{ doc("snowflake__metering_history") }}'
    primary_entity: account_metering

    dimensions:
      - name: start_date
        expr: start_time::date
        type: time
        type_params:
          time_granularity: day
      - name: service_type
        description: '{{ doc("snowflake__service_type") }}'
        type: categorical
      - name: service
        description: '{{ doc("snowflake__name") }}'
        type: categorical
        expr: name
    
    defaults:
      agg_time_dimension: start_date

    measures:
      - name: account_metering_total_elapsed_seconds
        description: '{{ doc("snowflake__total_elapsed_seconds") }}'
        agg: sum
        expr: DATEDIFF(second, start_time, end_time )

      - name: account_metering_longest_elapsed_seconds
        description: '{{ doc("snowflake__longest_elapsed_seconds") }}'
        agg: max
        expr: DATEDIFF(second, start_time, end_time )
      
      - name: account_metering_total_credits_used_compute
        description: '{{ doc("snowflake__credits_used_compute") }}'
        agg: sum
        expr: credits_used_compute

      - name: account_metering_max_credits_used_compute
        description: '{{ doc("snowflake__credits_used_compute") }}'
        agg: max
        expr: credits_used_compute

      - name: account_metering_total_credits_used_cloud_services
        description: '{{ doc("snowflake__credits_used_cloud_services") }}'
        agg: sum
        expr: credits_used_cloud_services

      - name: account_metering_max_credits_used_cloud_services
        description: '{{ doc("snowflake__credits_used_cloud_services") }}'
        agg: max
        expr: credits_used_cloud_services

      - name: account_metering_total_credits_used
        description: '{{ doc("snowflake__credits_used") }}'
        agg: sum
        expr: credits_used
      - name: account_metering_max_credits_used
        description: '{{ doc("snowflake__credits_used") }}'
        agg: max
        expr: credits_used

      - name: account_metering_total_bytes_loaded
        agg: sum
        expr: bytes
      - name: account_metering_total_files_loaded
        agg: max
        expr: files

metrics:
  - name: account_metering_total_elapsed_seconds
    description: Sum of total elapsed seconds which is end - start time.
    type: simple
    label: total elapsed seconds
    type_params: 
      measure: account_metering_total_elapsed_seconds

  - name: account_metering_total_credits_used_compute
    type: simple
    label: total credits used compute
    type_params: 
      measure: account_metering_total_credits_used_compute

  - name: account_metering_total_credits_used_cloud_services
    type: simple
    label: total credits used cloud services
    type_params: 
      measure: account_metering_total_credits_used_cloud_services

  - name: account_metering_total_credits_used
    type: simple
    label: total credits used
    type_params: 
      measure: account_metering_total_credits_used
    filter: | 
        account_metering_total_credits_used > 1

  - name: account_metering_total_bytes_loaded
    type: simple
    label: total bytes loaded
    type_params: 
      measure: account_metering_total_bytes_loaded

  - name: account_metering_total_files_loaded
    type: simple
    label: total files loaded
    type_params: 
      measure: account_metering_total_files_loaded
    filter: | 
        account_metering_total_files_loaded is not null

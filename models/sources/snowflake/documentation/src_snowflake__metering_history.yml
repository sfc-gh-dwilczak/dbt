version: 2

models:
  - name: src_snowflake__metering_history
    description: >
      The METERING_HISTORY view in the ACCOUNT_USAGE schema can be used to return 
      the hourly credit usage for an account within the last 365 days (1 year).
    columns:
      - name: service_type
        data_type: varchar
        description: '{{ doc("snowflake__service_type") }}'

      - name: start_time
        data_type: timestamp_ltz
        description: '{{ doc("snowflake__start_time") }}'

      - name: end_time
        data_type: timestamp_ltz
        description: '{{ doc("snowflake__end_time") }}'

      - name: entity_id
        data_type: number
        description: '{{ doc("snowflake__entity_id") }}'

      - name: name
        data_type: varchar
        description: '{{ doc("snowflake__name") }}'

      - name: credits_used_compute
        data_type: number
        description: '{{ doc("snowflake__credits_used_compute") }}'

      - name: credits_used_cloud_services
        data_type: number
        description: '{{ doc("snowflake__credits_used_cloud_services") }}'

      - name: credits_used
        data_type: number
        description: '{{ doc("snowflake__credits_used") }}'

      - name: bytes
        data_type: number
        description: '{{ doc("snowflake__bytes") }}'

      - name: files
        data_type: number
        description: '{{ doc("snowflake__files") }}'

      - name: rows_clustered
        description: '{{ doc("snowflake__rows_clustered") }}'

      - name: budget_id
        data_type: number
        description: '{{ doc("snowflake__budget_id") }}'

semantic_models:
  - name: account_metering
    description: >
      The METERING_HISTORY view in the ACCOUNT_USAGE schema can be used to return 
      the hourly credit usage for an account within the last 365 days (1 year).
    model: ref('src_snowflake__metering_history')
    defaults:
      agg_time_dimension: start_date
    primary_entity: account_metering
    dimensions:
      - name: start_date
        expr: start_time::date
        type: time
        type_params:
          time_granularity: day
      - name: service_type
        description: '{{ doc("snowflake__service_type") }}'
        type: categorical
      - name: service
        description: '{{ doc("snowflake__name") }}'
        type: categorical
        expr: name

    measures:
      - name: total_elapsed_seconds
        description: End time - start time for in which the usage took place.
        agg: sum
        expr: DATEDIFF(second, start_time, end_time )

      - name: longest_elapsed_seconds
        description: Longest running
        agg: max
        expr: DATEDIFF(second, start_time, end_time )
      
      - name: total_credits_used_compute
        agg: sum
        expr: credits_used_compute

      - name: max_credits_used_compute
        agg: max
        expr: credits_used_compute

      - name: total_credits_used_cloud_services
        agg: sum
        expr: credits_used_cloud_services
      - name: max_credits_used_cloud_services
        agg: max
        expr: credits_used_cloud_services

      - name: total_credits_used
        agg: sum
        expr: credits_used
      - name: max_credits_used
        agg: max
        expr: credits_used

      - name: total_bytes_loaded
        agg: sum
        expr: bytes
      - name: total_files_loaded
        agg: sum
        expr: files

metrics:
  - name: total_elapsed_seconds
    description: Sum of total elapsed seconds which is end - start time.
    type: simple
    label: total elapsed seconds
    type_params: 
      measure: total_elapsed_seconds

  - name: total_credits_used_compute
    type: simple
    label: total credits used compute
    type_params: 
      measure: total_credits_used_compute

  - name: total_credits_used_cloud_services
    type: simple
    label: total credits used cloud services
    type_params: 
      measure: total_credits_used_cloud_services

  - name: total_credits_used
    type: simple
    label: total credits used
    type_params: 
      measure: total_credits_used

  - name: total_bytes_loaded
    type: simple
    label: total bytes loaded
    type_params: 
      measure: total_bytes_loaded

  - name: total_files_loaded
    type: simple
    label: total files loaded
    type_params: 
      measure: total_files_loaded
    filter: | 
        total_files_loaded is not null

  
  
      